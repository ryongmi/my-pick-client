'use client';

import { useState, useEffect, useCallback, useRef } from 'react';
import Link from 'next/link';
import { Eye, Clock, Heart, Bookmark, Play, Youtube, Twitter } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { useAppDispatch, useAppSelector } from '@/hooks/redux';
import { useUI, useContent } from '@/hooks/redux';
import { setPlatformFilter, clearFilters } from '@/store/slices/uiSlice';
import { setSelectedPlatform, selectSelectedPlatform } from '@/store/slices/platformSlice';
import { updateFollowedCreators } from '@/store/slices/creatorSlice';
import { mockGetFollowedCreators } from '@/data/creators';
import { 
  fetchContent, 
  fetchMoreContent,
  toggleBookmarkOptimistic, 
  toggleLikeOptimistic, 
  bookmarkContent, 
  removeBookmark, 
  likeContent, 
  unlikeContent 
} from '@/store/slices/contentSlice';
import { cn } from '@/lib/utils';
import { formatNumber, formatDate } from '@/lib/utils';
import { PlatformFilter } from '@/components/admin/platforms/platform-filter';

const MOCK_CONTENT = [
  {
    id: '1',
    title: '„ÄêÊ≠å„Å£„Å¶„Åø„Åü„ÄëÏÉàÎ°úÏö¥ Ïª§Î≤ÑÍ≥° / Ado',
    description: 'Ïò§ÎäòÏùÄ ÌäπÎ≥ÑÌïú Ïª§Î≤ÑÍ≥°ÏùÑ Ï§ÄÎπÑÌñàÏñ¥Ïöî! ÎßéÏùÄ Î∂ÑÎì§Ïù¥ ÏöîÏ≤≠Ìï¥Ï£ºÏã† Í≥°Ïù∏Îç∞Ïöî...',
    thumbnail: '',
    platform: 'youtube' as const,
    creator: {
      id: 'ado',
      name: 'Ado',
      displayName: 'Ado',
      avatar: '',
    },
    publishedAt: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), // 2ÏãúÍ∞Ñ Ï†Ñ
    viewCount: 520000,
    likeCount: 45000,
    duration: '15:23',
    isBookmarked: false,
    isLiked: false,
  },
  {
    id: '2',
    title: '‰ªäÊó•„ÅØ„É¨„Ç≥„Éº„Éá„Ç£„É≥„Ç∞„Åß„Åó„ÅüÔºÅÊñ∞„Åó„ÅÑÊõ≤„ÇÇ„ÅÜ„Åô„ÅêÂÆåÊàê„Åó„Åæ„Åôüéµ',
    description: '',
    platform: 'twitter' as const,
    creator: {
      id: 'ado',
      name: 'Ado',
      displayName: 'Ado',
      avatar: '',
    },
    publishedAt: new Date(Date.now() - 30 * 60 * 1000).toISOString(), // 30Î∂Ñ Ï†Ñ
    likeCount: 5800,
    isBookmarked: false,
    isLiked: false,
  },
  {
    id: '3',
    title: '„ÄêÍ≤ÄÏ¶ù„Äë1000ÎßåÏõêÏùò „Äá„Äá ÏÇ¨Î¥§Îã§!',
    description: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! ÌûàÏπ¥ÌÇ®ÏûÖÎãàÎã§! Ïò§ÎäòÏùÄ Î¨¥Î†§ 1000ÎßåÏõêÏùò...',
    thumbnail: '',
    platform: 'youtube' as const,
    creator: {
      id: 'hikakin',
      name: 'ÌûàÏπ¥ÌÇ®',
      displayName: 'ÌûàÏπ¥ÌÇ®',
      avatar: '',
    },
    publishedAt: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(), // 5ÏãúÍ∞Ñ Ï†Ñ
    viewCount: 1200000,
    likeCount: 89000,
    duration: '8:45',
    isBookmarked: false,
    isLiked: false,
  },
];

export function MainContent() {
  const dispatch = useAppDispatch();
  const { filters } = useUI();
  const { contents, isLoading, hasMore, isLoadingMore, pagination } = useContent();
  const { followedCreators } = useAppSelector(state => state.creator);
  const selectedPlatform = useAppSelector(selectSelectedPlatform);
  const loadingRef = useRef<HTMLDivElement>(null);

  // ÌåîÎ°úÏö∞Ìïú ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞ Ï¥àÍ∏∞ Î°úÎìú
  useEffect(() => {
    if (followedCreators.length === 0) {
      const loadFollowed = async () => {
        const followed = await mockGetFollowedCreators();
        dispatch(updateFollowedCreators(followed.data || []));
      };
      loadFollowed();
    }
  }, [dispatch, followedCreators.length]);

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏΩòÌÖêÏ∏† Î°úÎìú
  useEffect(() => {
    console.log('[DEBUG] Fetching content with filters:', {
      creators: filters.selectedCreators,
      platforms: [selectedPlatform],
      sortBy: 'newest'
    });
    dispatch(fetchContent({
      creators: filters.selectedCreators,
      platforms: [selectedPlatform],
      sortBy: 'newest'
    }));
  }, [dispatch, filters.selectedCreators, selectedPlatform]);

  // contents Î∞∞Ïó¥ Î≥ÄÍ≤Ω Í∞êÏßÄ (ÎîîÎ≤ÑÍπÖÏö©)
  useEffect(() => {
    console.log('[DEBUG] Contents updated:', {
      count: contents.length,
      hasMore,
      isLoadingMore,
      currentPage: pagination.page
    });
  }, [contents, hasMore, isLoadingMore, pagination.page]);

  // Î¨¥Ìïú Ïä§ÌÅ¨Î°§ Î°úÏßÅ
  const loadMoreContent = useCallback(() => {
    if (hasMore && !isLoadingMore && !isLoading) {
      console.log('[DEBUG] Loading more content:', {
        nextPage: pagination.page + 1,
        creators: filters.selectedCreators,
        platforms: [selectedPlatform]
      });
      dispatch(fetchMoreContent({
        page: pagination.page + 1,
        creators: filters.selectedCreators,
        platforms: [selectedPlatform],
        sortBy: 'newest'
      }));
    } else {
      console.log('[DEBUG] Cannot load more:', {
        hasMore,
        isLoadingMore,
        isLoading
      });
    }
  }, [dispatch, hasMore, isLoadingMore, isLoading, pagination.page, filters.selectedCreators, selectedPlatform]);

  // Intersection ObserverÎ•º ÏÇ¨Ïö©Ìïú Ïä§ÌÅ¨Î°§ Í∞êÏßÄ
  useEffect(() => {
    const loadingElement = loadingRef.current;
    if (!loadingElement || !hasMore) {return;}

    const observer = new IntersectionObserver(
      (entries) => {
        if (entries[0]?.isIntersecting) {
          loadMoreContent();
        }
      },
      { threshold: 0.1 }
    );

    observer.observe(loadingElement);

    return () => {
      observer.disconnect();
    };
  }, [loadMoreContent, hasMore]);

  const handlePlatformFilter = (platform: string) => {
    dispatch(setSelectedPlatform(platform));
    dispatch(setPlatformFilter([platform]));
  };

  // ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞ Ïù¥Î¶ÑÏùÑ Ï†ïÌôïÌûà Í∞ÄÏ†∏Ïò§Îäî Ìï®Ïàò
  const getCreatorDisplayName = (creatorId: string) => {
    const creator = followedCreators.find(c => c.id === creatorId);
    return creator?.displayName || creatorId;
  };

  // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
  const handleClearFilters = () => {
    dispatch(clearFilters());
    dispatch(setSelectedPlatform('all'));
  };

  const handleBookmark = async (contentId: string) => {
    // ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏
    dispatch(toggleBookmarkOptimistic(contentId));
    
    // Ïã§Ï†ú API Ìò∏Ï∂ú
    const content = contents.find(c => c.id === contentId);
    try {
      if (content?.isBookmarked) {
        await dispatch(removeBookmark(contentId)).unwrap();
      } else {
        await dispatch(bookmarkContent(contentId)).unwrap();
      }
    } catch (error) {
      // ÏóêÎü¨ Ïãú Î°§Î∞±
      dispatch(toggleBookmarkOptimistic(contentId));
      console.error('Î∂ÅÎßàÌÅ¨ Ï≤òÎ¶¨ Ïã§Ìå®:', error);
    }
  };

  const handleLike = async (contentId: string) => {
    // ÎÇôÍ¥ÄÏ†Å ÏóÖÎç∞Ïù¥Ìä∏
    dispatch(toggleLikeOptimistic(contentId));
    
    // Ïã§Ï†ú API Ìò∏Ï∂ú
    const content = contents.find(c => c.id === contentId);
    try {
      if (content?.isLiked) {
        await dispatch(unlikeContent(contentId)).unwrap();
      } else {
        await dispatch(likeContent(contentId)).unwrap();
      }
    } catch (error) {
      // ÏóêÎü¨ Ïãú Î°§Î∞±
      dispatch(toggleLikeOptimistic(contentId));
      console.error('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ïã§Ìå®:', error);
    }
  };

  // Redux storeÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏΩòÌÖêÏ∏† ÏÇ¨Ïö© (Î¨¥ÌïúÏä§ÌÅ¨Î°§ Î∞òÏòÅ)
  const displayContent = contents;
  
  const filteredContent = displayContent.filter(content => {
    // ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞ ÌïÑÌÑ∞ - ÌåîÎ°úÏö∞Ìïú ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞ Í∏∞Ï§ÄÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
    let creatorMatch = false;
    
    if (filters.selectedCreators.includes('all')) {
      // Ï†ÑÏ≤¥ Î≥¥Í∏∞ Ïãú Î°úÏßÅ Í∞úÏÑ†
      if (followedCreators.length > 0) {
        // ÌåîÎ°úÏö∞Ìïú ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞Îßå ÌëúÏãú
        const followedCreatorIds = followedCreators.map(c => c.id);
        creatorMatch = content.creator ? followedCreatorIds.includes(content.creator.id) : false;
      } else {
        // ÌåîÎ°úÏö∞Ìïú ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Î™®Îì† Ïª®ÌÖêÏ∏† ÌëúÏãú (Ï¥àÍ∏∞ ÏÇ¨Ïö©Ïûê)
        creatorMatch = true;
      }
    } else {
      // ÌäπÏ†ï ÌÅ¨Î¶¨ÏóêÏù¥ÌÑ∞ ÏÑ†ÌÉù Ïãú
      creatorMatch = content.creator ? filters.selectedCreators.includes(content.creator.id) : false;
    }
    
    // ÌîåÎû´Ìèº ÌïÑÌÑ∞
    const platformMatch = selectedPlatform === 'all' || content.platform === selectedPlatform;
    
    return creatorMatch && platformMatch;
  });

  const renderContentCard = (content: any) => {
    if (content.platform === 'youtube') {
      return (
        <Link href={`/video/${content.id}`} key={content.id}>
          <Card className="overflow-hidden hover:shadow-lg transition-shadow cursor-pointer group">
            <div className="flex flex-col sm:flex-row">
              {/* Ïç∏ÎÑ§Ïùº */}
              <div className="relative w-full sm:w-64 h-48 sm:h-36 flex-shrink-0">
                <div className="w-full h-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center group-hover:scale-105 transition-transform">
                  <Play className="h-12 w-12 text-white" />
                </div>
                <span className="absolute bottom-2 right-2 bg-black/75 text-white text-xs px-2 py-1 rounded">
                  {content.duration}
                </span>
                <div className="absolute top-2 left-2 bg-red-600 text-white text-xs px-2 py-1 rounded flex items-center">
                  <Youtube className="h-3 w-3 mr-1" />
                  YouTube
                </div>
              </div>
            
            {/* ÏΩòÌÖêÏ∏† Ï†ïÎ≥¥ */}
            <div className="p-4 flex-1">
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <h3 className="font-bold text-lg mb-2 line-clamp-2">{content.title}</h3>
                  <div className="flex items-center text-sm text-muted-foreground mb-2 space-x-4">
                    <div className="flex items-center">
                      <div className={cn(
                        'w-6 h-6 rounded-full mr-2 flex items-center justify-center text-white text-xs font-bold',
                        content.creator.id === 'ado' ? 'gradient-ado' : 'gradient-hikakin'
                      )}>
                        {content.creator.displayName.charAt(0)}
                      </div>
                      <span className="font-medium">{content.creator.displayName}</span>
                    </div>
                    <div className="flex items-center">
                      <Eye className="h-3 w-3 mr-1" />
                      <span>{formatNumber(content.viewCount)}Ìöå</span>
                    </div>
                    <div className="flex items-center">
                      <Clock className="h-3 w-3 mr-1" />
                      <span>{formatDate(content.publishedAt, 'relative')}</span>
                    </div>
                  </div>
                  <p className="text-sm text-muted-foreground line-clamp-2">
                    {content.description}
                  </p>
                </div>
                <div className="flex space-x-2 ml-4">
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      handleBookmark(content.id);
                    }}
                    className={cn(
                      content.isBookmarked && 'text-blue-600'
                    )}
                  >
                    <Bookmark className={cn(
                      'h-4 w-4',
                      content.isBookmarked && 'fill-current'
                    )} />
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      handleLike(content.id);
                    }}
                    className={cn(
                      content.isLiked && 'text-red-600'
                    )}
                  >
                    <Heart className={cn(
                      'h-4 w-4',
                      content.isLiked && 'fill-current'
                    )} />
                  </Button>
                </div>
              </div>
            </div>
          </div>
        </Card>
        </Link>
      );
    } else {
      // Twitter Ìè¨Ïä§Ìä∏
      return (
        <Card key={content.id} className="p-4 hover:shadow-lg transition-shadow">
          <div className="flex items-start">
            <div className={cn(
              'w-12 h-12 rounded-full mr-3 flex-shrink-0 flex items-center justify-center text-white font-bold',
              content.creator.id === 'ado' ? 'gradient-ado' : 'gradient-hikakin'
            )}>
              {content.creator.displayName.charAt(0)}
            </div>
            <div className="flex-1">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center flex-wrap">
                  <h4 className="font-bold mr-2">{content.creator.displayName}</h4>
                  <span className="text-muted-foreground text-sm">@{content.creator.name}</span>
                  <div className="flex items-center ml-3 text-sm text-muted-foreground">
                    <Clock className="h-3 w-3 mr-1" />
                    <span>{formatDate(content.publishedAt, 'relative')}</span>
                  </div>
                </div>
                <div className="bg-blue-400 text-white text-xs px-2 py-1 rounded flex items-center">
                  <Twitter className="h-3 w-3 mr-1" />
                  Twitter
                </div>
              </div>
              <p className="mb-3">{content.title}</p>
              <div className="bg-gradient-to-br from-pink-100 to-purple-100 rounded-lg h-32 flex items-center justify-center mb-3">
                <div className="text-4xl">üéµ</div>
              </div>
              <div className="flex items-center text-muted-foreground text-sm space-x-6">
                <Button variant="ghost" size="sm" className="h-auto p-1">
                  <span className="mr-1">üí¨</span> 234
                </Button>
                <Button variant="ghost" size="sm" className="h-auto p-1">
                  <span className="mr-1">üîÑ</span> 1.2K
                </Button>
                <Button
                  variant="ghost"
                  size="sm"
                  className={cn(
                    'h-auto p-1',
                    content.isLiked && 'text-red-600'
                  )}
                  onClick={() => handleLike(content.id)}
                >
                  <Heart className={cn(
                    'h-3 w-3 mr-1',
                    content.isLiked && 'fill-current'
                  )} />
                  {formatNumber(content.likeCount)}
                </Button>
                <Button variant="ghost" size="sm" className="h-auto p-1">
                  <span className="mr-1">üì§</span>
                </Button>
              </div>
            </div>
          </div>
        </Card>
      );
    }
  };

  return (
    <div className="w-full max-w-7xl mx-auto">
      <div className="space-y-6">
        {/* ÌïÑÌÑ∞ ÏÉÅÌÉú ÌëúÏãú */}
        <div className="bg-background rounded-lg shadow-sm p-4 border">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <span className="text-sm text-muted-foreground">ÌòÑÏû¨ ÌïÑÌÑ∞:</span>
            <div className="flex items-center space-x-2">
              {filters.selectedCreators.includes('all') ? (
                <span className="bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">
                  Ï†ÑÏ≤¥ Î≥¥Í∏∞
                </span>
              ) : (
                filters.selectedCreators.map(creatorId => (
                  <span key={creatorId} className="bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">
                    {getCreatorDisplayName(creatorId)}
                  </span>
                ))
              )}
            </div>
          </div>
          <Button 
            variant="ghost" 
            size="sm" 
            className="text-muted-foreground hover:text-foreground"
            onClick={handleClearFilters}
          >
            ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
          </Button>
        </div>
        </div>

        {/* ÎèôÏ†Å ÌîåÎû´Ìèº ÌïÑÌÑ∞ */}
        <PlatformFilter
          selectedPlatform={selectedPlatform}
          onPlatformChange={handlePlatformFilter}
        />

        {/* ÏΩòÌÖêÏ∏† ÌÉÄÏûÑÎùºÏù∏ */}
        <div className="space-y-6">
      {isLoading ? (
            // Î°úÎî© ÏÉÅÌÉú
            <div className="space-y-6">
              {[1, 2, 3].map((i) => (
                <div key={i} className="bg-white rounded-lg shadow-sm p-4 animate-pulse">
                  <div className="flex">
                    <div className="w-64 h-36 bg-gray-200 rounded"></div>
                    <div className="flex-1 p-4">
                      <div className="h-6 bg-gray-200 rounded mb-2"></div>
                      <div className="h-4 bg-gray-200 rounded mb-2 w-3/4"></div>
                      <div className="h-4 bg-gray-200 rounded w-1/2"></div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : filteredContent.length > 0 ? (
            <>
              {filteredContent.map((content, index) => (
                <div key={content.id} className={index > 0 ? "mt-6" : ""}>
                  {renderContentCard(content)}
                </div>
              ))}
            </>
          ) : (
            <div className="text-center py-12">
              <p className="text-muted-foreground">ÏÑ†ÌÉùÌïú ÌïÑÌÑ∞Ïóê ÎßûÎäî ÏΩòÌÖêÏ∏†Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
            </div>
          )}
        
        {/* Î¨¥Ìïú Ïä§ÌÅ¨Î°§ Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ */}
        {hasMore ? <div 
            ref={loadingRef}
            className="py-8 text-center"
          >
            {isLoadingMore ? (
              <div className="inline-flex items-center">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mr-3"></div>
                <span className="text-muted-foreground">Îçî ÎßéÏùÄ ÏΩòÌÖêÏ∏†Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</span>
              </div>
            ) : (
              <div className="text-muted-foreground text-sm">
                Ïä§ÌÅ¨Î°§ÌïòÏó¨ Îçî ÎßéÏùÄ ÏΩòÌÖêÏ∏† Î≥¥Í∏∞
              </div>
            )}
          </div> : null}
        
        {/* Î™®Îì† ÏΩòÌÖêÏ∏† Î°úÎìú ÏôÑÎ£å Î©îÏãúÏßÄ */}
        {!hasMore && !isLoading && filteredContent.length > 0 && (
          <div className="py-8 text-center">
            <span className="text-muted-foreground text-sm">Î™®Îì† ÏΩòÌÖêÏ∏†Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§</span>
          </div>
        )}
        </div>
      </div>
    </div>
  );
}
